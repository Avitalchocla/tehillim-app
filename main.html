<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תהילים קבוצתי - מחזור 30 יום</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4CAF50">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
            color: #333;
            direction: rtl; /* Force RTL for the entire body */
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
        }
        h1, h2, h3 {
            color: #4CAF50;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #4CAF50;
            border-color: #4CAF50;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #45a049;
            border-color: #45a049;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }
        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }
        .panel {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .chapter-box {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-box.read {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
            font-weight: bold;
        }
        .admin-section button {
            margin: 5px;
        }
        .message-box {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .login-panel, .participant-panel, .admin-panel {
            display: none; /* Hidden by default, shown by JS */
        }
        .participant-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .participant-item:last-child {
            border-bottom: none;
        }
        .participant-item span {
            font-size: 1.05em;
        }
        .confirm-dialog {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
        }
        .confirm-dialog p {
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Progress View specific styles */
        .progress-view {
            display: none; /* Hidden by default */
        }
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* 3 columns for desktop, adjust for mobile */
            gap: 10px;
            margin-top: 20px;
        }
        .progress-chapter-box {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px;
        }
        .progress-chapter-box.read {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .progress-chapter-box span {
            font-size: 0.9em;
            color: #555;
        }
        .progress-chapter-box.read span {
            color: #155724;
        }
        .progress-chapter-box .chapter-number {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        .progress-chapter-box .reader-name {
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .progress-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* More columns for smaller screens */
            }
            .main-container {
                padding: 15px;
            }
        }
        .admin-panel-tabs .nav-link.active {
            background-color: #4CAF50;
            color: white;
        }
        .admin-panel-tabs .nav-link {
            color: #4CAF50;
        }
        .admin-panel-tabs .nav-item {
            flex-grow: 1;
        }
        .edit-history-panel {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; /* Above overlay */
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .edit-history-panel .form-group {
            margin-bottom: 15px;
            text-align: right;
        }
        .edit-history-panel .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .edit-history-panel select,
        .edit-history-panel input[type="datetime-local"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="messageBox" class="message-box"></div>

        <div class="overlay" id="overlay"></div>
        <div class="confirm-dialog" id="confirmDialog">
            <p id="confirmMessage"></p>
            <button id="confirmYesBtn" class="btn btn-primary m-2">כן</button>
            <button id="confirmNoBtn" class="btn btn-secondary m-2">לא</button>
        </div>

        <div id="loginPanel" class="login-panel">
            <h2>ברוכים הבאים</h2>
            <div class="mb-3">
                <input type="text" id="usernameInput" class="form-control text-center" placeholder="הכנס שם משתמש">
            </div>
            <div class="mb-3">
                <input type="password" id="passwordInput" class="form-control text-center" placeholder="הכנס סיסמת מנהל">
            </div>
            <button id="loginBtn" class="btn btn-primary w-100 mb-2">התחבר / התחבר כאורח</button>
        </div>

        <div id="participantPanel" class="participant-panel">
            <p>מחובר כ: <span id="currentParticipantName" class="fw-bold"></span></p>
            <h3>היום במחזור: יום <span id="currentDay">1</span></h3>
            <div class="chapter-info">
                <p>פרקי היום: <span id="currentChapterRange" class="fw-bold"></span></p>
                <p id="currentChapterReader">טרם נקרא</p>
            </div>
            <button id="markAsReadBtn" class="btn btn-primary mt-3 w-100">סימנתי כקראתי</button>
            <button id="viewProgressBtn" class="btn btn-info mt-2 w-100">צפה בהתקדמות המחזור</button>
            <button id="logoutBtn" class="btn btn-secondary mt-2 w-100">התנתק</button>
        </div>

        <div id="adminPanel" class="admin-panel">
            <h2>ניהול מערכת - מנהל ראשי</h2>
            <ul class="nav nav-tabs admin-panel-tabs mb-3" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="current-day-tab" data-bs-toggle="tab" data-bs-target="#currentDayTab" type="button" role="tab" aria-controls="currentDayTab" aria-selected="true">יום נוכחי</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participantsTab" type="button" role="tab" aria-controls="participantsTab" aria-selected="false">משתתפים</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="chapters-tab" data-bs-toggle="tab" data-bs-target="#chaptersTab" type="button" role="tab" aria-controls="chaptersTab" aria-selected="false">פרקים</button>
                </li>
            </ul>
            <div class="tab-content" id="adminTabsContent">
                <div class="tab-pane fade show active" id="currentDayTab" role="tabpanel" aria-labelledby="current-day-tab">
                    <h3>יום נוכחי: יום <span id="adminCurrentDay">1</span></h3>
                    <div class="d-grid gap-2">
                        <button id="incrementDayBtn" class="btn btn-warning">העבר ליום הבא במחזור</button>
                        <button id="resetCycleBtn" class="btn btn-danger">אפס את כל מחזור התהילים</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="participantsTab" role="tabpanel" aria-labelledby="participants-tab">
                    <h3>ניהול משתתפים</h3>
                    <div class="d-grid gap-2">
                        <button id="addParticipantBtn" class="btn btn-success">הוסף משתתף חדש</button>
                    </div>
                    <div id="addParticipantSection" class="panel mt-3" style="display: none;">
                        <h4>הוסף משתתף ידנית</h4>
                        <div class="mb-3">
                            <input type="text" id="newParticipantNameInput" class="form-control text-center" placeholder="שם המשתתף">
                        </div>
                        <div class="mb-3">
                            <input type="tel" id="newParticipantPhoneInput" class="form-control text-center" placeholder="מספר טלפון (אופציונלי)">
                        </div>
                        <button id="confirmAddParticipantBtn" class="btn btn-primary w-100 mb-2">אשר הוספה</button>
                        <button id="cancelAddParticipantBtn" class="btn btn-secondary w-100">ביטול</button>
                    </div>

                    <div class="participant-list mt-3" id="participantsList">
                        </div>
                </div>

                <div class="tab-pane fade" id="chaptersTab" role="tabpanel" aria-labelledby="chapters-tab">
                    <h3>סטטוסי פרקים</h3>
                    <div class="chapter-list-admin" id="chapterListAdmin">
                        </div>
                </div>
            </div>
            <button id="dataManagementBtn" class="btn btn-info mt-3 w-100">ניהול נתונים</button>
            <button id="logoutAdminBtn" class="btn btn-secondary mt-2 w-100">התנתק ממנהל</button>
        </div>

        <div id="progressView" class="progress-view">
            <h2>התקדמות המחזור</h2>
            <div class="progress-grid" id="progressGrid">
                </div>
            <button id="backToReadingBtn" class="btn btn-secondary mt-3 w-100">חזור לקריאה</button>
        </div>

        <div id="selectedParticipantHistory" class="edit-history-panel">
            <h4>היסטוריית קריאה עבור: <span id="participantHistoryName"></span></h4>
            <div class="participant-history-list mt-3" id="participantHistoryList">
                </div>
            <button id="cancelParticipantHistoryBtn" class="btn btn-secondary mt-3 w-100">סגור</button>
        </div>

        <div id="editReadingHistoryPanel" class="edit-history-panel">
            <h4>ערוך קריאה ליום <span id="editChapterDay"></span></h4>
            <div class="form-group mb-3">
                <label for="editReaderSelect">נקרא על ידי:</label>
                <select id="editReaderSelect" class="form-control"></select>
            </div>
            <div class="form-group mb-3">
                <label for="editTimestampInput">תאריך ושעת קריאה:</label>
                <input type="datetime-local" id="editTimestampInput" class="form-control">
            </div>
            <div class="d-grid gap-2">
                <button id="saveEditHistoryBtn" class="btn btn-primary">שמור שינויים</button>
                <button id="clearReadingBtn" class="btn btn-warning">נקה קריאה</button>
                <button id="hideEditHistoryBtn" class="btn btn-secondary">ביטול</button>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="tehillim-data.js"></script>
    <script type="module"> // // ייבוא הפונקציות מפיירבייס SDK
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, query, where, deleteField } from 'firebase/firestore';
        import { getAnalytics } from "firebase/analytics"; // הוספתי את האנליטיקס

        // תצורת הפיירבייס שלך (העתק/הדבק ממה שקיבלת בשלב 2 - עם הערכים האמיתיים שלך)
        const firebaseConfig = {
            apiKey: "AIzaSyA0KVIg6Nc0VkF-5vsJv4HXi7JT5VFNXXo",
            authDomain: "tehillim-elazar-2025-640ee.firebaseapp.com",
            projectId: "tehillim-elazar-2025-640ee",
            storageBucket: "tehillim-elazar-2025-640ee.firebasestorage.app",
            messagingSenderId: "152354805626",
            appId: "1:152354805626:web:86be1996bff432b581a8c3",
            measurementId: "G-7FQ5FDEMHF"
        };

        // אתחול פיירבייס
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // זו הפנייה לבסיס הנתונים שלנו (Firestore)
        const analytics = getAnalytics(app); // אתחול אנליטיקס

        // לצורך בדיקה ראשונית בלבד - נראה ב-console אם התחברנו
        console.log("Firebase initialized successfully!");
        console.log("Firestore DB object:", db);
        console.log("Analytics object:", analytics);
        // // הוספתי type="module" לשורת ה-script הפותחת. זה חיוני עבור פקודות import.

        // Check for Service Worker support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // --- שאר קוד ה-JavaScript הקיים שלך מתחיל מכאן ---
        // (לדוגמה, המשתנים הגלובליים, הגדרות ה-DOM וכו')

        // Constants for Local Storage (will be replaced by Firebase later)
        const ADMIN_PASSWORD_KEY = 'tehillim_admin_password';
        const IS_ADMIN_LOGGED_IN_KEY = 'tehillim_is_admin_logged_in';
        const CURRENT_DAY_KEY = 'tehillim_current_day';
        const CHAPTER_STATUSES_KEY = 'tehillim_chapter_statuses';
        const PARTICIPANTS_KEY = 'tehillim_participants';
        const LAST_ASSIGNMENT_DATE_KEY = 'tehillim_last_assignment_date'; // For automatic day increment

        // Global variables (will eventually be managed by Firebase)
        let currentDay = 1;
        let chapterStatuses = {}; // Stores { day: { reader: 'Name', timestamp: 'ISO string' } }
        let participants = []; // Stores { id: 'uuid', name: 'Name', phone: '123' }
        let currentParticipantId = null;
        let currentEditedChapterDay = null; // For admin edit history
        let currentEditedParticipantId = null; // For admin participant history

        // DOM Elements
        const mainContainer = document.querySelector('.main-container');
        const messageBox = document.getElementById('messageBox');

        const loginPanel = document.getElementById('loginPanel');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');

        const participantPanel = document.getElementById('participantPanel');
        const currentParticipantNameSpan = document.getElementById('currentParticipantName');
        const currentDaySpan = document.getElementById('currentDay');
        const currentChapterRangeSpan = document.getElementById('currentChapterRange');
        const currentChapterReaderSpan = document.getElementById('currentChapterReader');
        const markAsReadBtn = document.getElementById('markAsReadBtn');
        const viewProgressBtn = document.getElementById('viewProgressBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        const adminPanel = document.getElementById('adminPanel');
        const adminCurrentDaySpan = document.getElementById('adminCurrentDay');
        const incrementDayBtn = document.getElementById('incrementDayBtn');
        const resetCycleBtn = document.getElementById('resetCycleBtn');
        const dataManagementBtn = document.getElementById('dataManagementBtn');
        const logoutAdminBtn = document.getElementById('logoutAdminBtn');

        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const addParticipantSection = document.getElementById('addParticipantSection');
        const newParticipantNameInput = document.getElementById('newParticipantNameInput');
        const newParticipantPhoneInput = document.getElementById('newParticipantPhoneInput');
        const confirmAddParticipantBtn = document.getElementById('confirmAddParticipantBtn');
        const cancelAddParticipantBtn = document.getElementById('cancelAddParticipantBtn');
        const participantsList = document.getElementById('participantsList');

        const chapterListAdmin = document.getElementById('chapterListAdmin');
        const progressView = document.getElementById('progressView');
        const progressGrid = document.getElementById('progressGrid');
        const backToReadingBtn = document.getElementById('backToReadingBtn');

        const confirmDialog = document.getElementById('confirmDialog');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const overlay = document.getElementById('overlay');

        const selectedParticipantHistoryPanel = document.getElementById('selectedParticipantHistory');
        const participantHistoryNameSpan = document.getElementById('participantHistoryName');
        const participantHistoryList = document.getElementById('participantHistoryList');
        const cancelParticipantHistoryBtn = document.getElementById('cancelParticipantHistoryBtn');

        const editReadingHistoryPanel = document.getElementById('editReadingHistoryPanel');
        const editChapterDaySpan = document.getElementById('editChapterDay');
        const editReaderSelect = document.getElementById('editReaderSelect');
        const editTimestampInput = document.getElementById('editTimestampInput');
        const saveEditHistoryBtn = document.getElementById('saveEditHistoryBtn');
        const clearReadingBtn = document.getElementById('clearReadingBtn');
        const hideEditHistoryBtn = document.getElementById('hideEditHistoryBtn');


        // Helper Functions
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showMessage(msg, type = 'info') {
            messageBox.textContent = msg;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        function clearMessages() {
            messageBox.style.display = 'none';
        }

        function showConfirm(message, callback) {
            confirmMessage.textContent = message;
            confirmDialog.style.display = 'block';
            overlay.style.display = 'block';

            const onConfirm = (confirmed) => {
                confirmDialog.style.display = 'none';
                overlay.style.display = 'none';
                confirmYesBtn.removeEventListener('click', onYes);
                confirmNoBtn.removeEventListener('click', onNo);
                callback(confirmed);
            };

            const onYes = () => onConfirm(true);
            const onNo = () => onConfirm(false);

            confirmYesBtn.addEventListener('click', onYes);
            confirmNoBtn.addEventListener('click', onNo);
        }

        function isValidPhoneNumber(phone) {
            // Updated regex to allow optional + prefix, only digits, and length between 7-15
            const phoneRegex = /^\+?\d{7,15}$/;
            return phoneRegex.test(phone);
        }

        function formatPhoneNumber(phone) {
            // Remove all non-digit characters
            let digits = phone.replace(/\D/g, '');

            // Add +972 if it's an Israeli number without prefix
            if (digits.length === 10 && digits.startsWith('0')) {
                digits = '972' + digits.substring(1);
            }
            // If it's already +972, ensure no 0 after
            else if (digits.length > 3 && digits.startsWith('972') && digits.charAt(3) === '0') {
                digits = '972' + digits.substring(4);
            }
            return '+' + digits;
        }


        // Load/Save Functions (Local Storage based - will be replaced by Firebase)
        function loadData() {
            currentDay = parseInt(localStorage.getItem(CURRENT_DAY_KEY) || '1');
            chapterStatuses = JSON.parse(localStorage.getItem(CHAPTER_STATUSES_KEY) || '{}');
            participants = JSON.parse(localStorage.getItem(PARTICIPANTS_KEY) || '[]');
            currentParticipantId = localStorage.getItem('currentParticipantId');

            // If participant was deleted or doesn't exist, clear currentParticipantId
            if (currentParticipantId && !participants.find(p => p.id === currentParticipantId)) {
                currentParticipantId = null;
                localStorage.removeItem('currentParticipantId');
            }
        }

        function saveCurrentDay() {
            localStorage.setItem(CURRENT_DAY_KEY, currentDay.toString());
        }

        function saveChapterStatuses() {
            localStorage.setItem(CHAPTER_STATUSES_KEY, JSON.stringify(chapterStatuses));
        }

        function saveParticipants() {
            localStorage.setItem(PARTICIPANTS_KEY, JSON.stringify(participants));
        }

        // Logic Functions
        function updateDisplay() {
            const isAdminLoggedIn = localStorage.getItem(IS_ADMIN_LOGGED_IN_KEY) === 'true';

            loginPanel.style.display = 'none';
            participantPanel.style.display = 'none';
            adminPanel.style.display = 'none';
            dataManagementBtn.style.display = 'none';
            progressView.style.display = 'none';
            selectedParticipantHistoryPanel.style.display = 'none';
            editReadingHistoryPanel.style.display = 'none'; // Hide edit panel on main display update

            if (isAdminLoggedIn) {
                adminPanel.style.display = 'block';
                dataManagementBtn.style.display = 'block';
                updateAdminPanel();
                // updateDisplay might be called when entering admin, hide participant history when switching to admin
                document.getElementById('selectedParticipantHistory').style.display = 'none';
            } else if (currentParticipantId) {
                const participant = participants.find(p => p.id === currentParticipantId);
                if (participant) {
                    participantPanel.style.display = 'block';
                    currentParticipantNameSpan.textContent = participant.name;
                    assignTodaysChapterToParticipant(participant); // This also updates currentDay/ChapterRange
                } else {
                    // Participant ID in localStorage but not found in list (e.g. deleted by admin)
                    loginPanel.style.display = 'block';
                    currentParticipantId = null;
                    localStorage.removeItem('currentParticipantId');
                    showMessage("המשתמש שלך הוסר או שונה. אנא התחבר מחדש.", "error");
                }
            } else {
                loginPanel.style.display = 'block';
            }
            hideEditReadingHistoryPanel(); // Always hide edit panel on main display update
        }

        function updateAdminPanel() {
            adminCurrentDaySpan.textContent = currentDay;
            updateParticipantList();
            updateChapterListAdmin();
        }

        function updateParticipantList() {
            participantsList.innerHTML = '';
            if (participants.length === 0) {
                participantsList.innerHTML = '<p class="text-center text-muted">אין משתתפים רשומים.</p>';
                return;
            }

            participants.forEach(p => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <span>${p.name} (${p.phone || 'אין טלפון'})</span>
                    <div>
                        <button class="btn btn-sm btn-info view-history-btn" data-id="${p.id}"><i class="fas fa-history"></i></button>
                        <button class="btn btn-sm btn-danger delete-participant-btn" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                participantsList.appendChild(item);
            });

            document.querySelectorAll('.delete-participant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToDelete = e.target.closest('button').dataset.id;
                    deleteParticipant(idToDelete);
                });
            });

            document.querySelectorAll('.view-history-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToView = e.target.closest('button').dataset.id;
                    showParticipantHistory(idToView);
                });
            });
        }

        function updateChapterListAdmin() {
            chapterListAdmin.innerHTML = '';
            for (let i = 1; i <= 30; i++) {
                const chapter = window.tehillimChapters[i];
                const status = chapterStatuses[i];
                const isCurrent = (i === currentDay) ? ' (היום)' : '';
                const readerInfo = status && status.reader ? `<br><span>נקרא ע"י: ${status.reader}</span>` : '<br><span class="text-muted">טרם נקרא</span>';
                const statusClass = status && status.reader ? 'read' : '';

                const item = document.createElement('div');
                item.className = `chapter-box ${statusClass} d-flex justify-content-between align-items-center`;
                item.innerHTML = `
                    <span>
                        יום ${i}: פרקים ${chapter.chapters} ${isCurrent}
                        ${readerInfo}
                    </span>
                    <button class="btn btn-sm btn-warning edit-chapter-btn" data-day="${i}">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                chapterListAdmin.appendChild(item);
            }

            document.querySelectorAll('.edit-chapter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const dayToEdit = parseInt(e.target.closest('button').dataset.day);
                    showEditReadingHistoryPanel(dayToEdit);
                });
            });
        }

        function showEditReadingHistoryPanel(day) {
            currentEditedChapterDay = day;
            editChapterDaySpan.textContent = day;

            // Populate reader select
            editReaderSelect.innerHTML = '<option value="">(בחר קורא)</option>';
            participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                editReaderSelect.appendChild(option);
            });

            const currentStatus = chapterStatuses[day];
            if (currentStatus && currentStatus.readerId) {
                editReaderSelect.value = currentStatus.readerId;
                editTimestampInput.value = currentStatus.timestamp ? new Date(currentStatus.timestamp).toISOString().slice(0, 16) : '';
            } else {
                editReaderSelect.value = '';
                editTimestampInput.value = '';
            }

            editReadingHistoryPanel.style.display = 'block';
            overlay.style.display = 'block';
        }

        function hideEditReadingHistoryPanel() {
            editReadingHistoryPanel.style.display = 'none';
            overlay.style.display = 'none';
            currentEditedChapterDay = null;
        }

        function saveEditHistory() {
            if (currentEditedChapterDay === null) return;

            const selectedParticipantId = editReaderSelect.value;
            const timestamp = editTimestampInput.value;

            if (!selectedParticipantId) {
                clearChapterReading(currentEditedChapterDay); // No reader selected, clear the reading
            } else {
                const participant = participants.find(p => p.id === selectedParticipantId);
                if (participant) {
                    const statusData = {
                        reader: participant.name,
                        readerId: participant.id,
                        timestamp: timestamp ? new Date(timestamp).toISOString() : new Date().toISOString()
                    };
                    chapterStatuses[currentEditedChapterDay] = statusData;
                    saveChapterStatuses(); // Save to local storage
                    showMessage(`קריאה ליום ${currentEditedChapterDay} עודכנה.`);
                } else {
                    showMessage("הקורא שנבחר לא נמצא.", "error");
                }
            }
            hideEditReadingHistoryPanel();
            updateAdminPanel();
        }

        function clearChapterReading(day, showConfirmDialog = false) {
            const executeClear = () => {
                delete chapterStatuses[day];
                saveChapterStatuses(); // Save to local storage
                showMessage(`קריאה ליום ${day} נוקתה בהצלחה.`);
                updateAdminPanel();
                hideEditReadingHistoryPanel(); // Hide after clearing
            };

            if (showConfirmDialog) {
                showConfirm(`האם אתה בטוח שברצונך למחוק את הקריאה ליום ${day}?`, (confirmed) => {
                    if (confirmed) {
                        executeClear();
                    }
                });
            } else {
                executeClear();
            }
        }


        function assignTodaysChapterToParticipant(participant) {
            const today = getTodayDateString();
            const lastAssignmentDate = localStorage.getItem(LAST_ASSIGNMENT_DATE_KEY);

            // If it's a new day, increment currentDay
            if (today !== lastAssignmentDate) {
                localStorage.setItem(LAST_ASSIGNMENT_DATE_KEY, today);
                currentDay = (currentDay % 30) + 1;
                saveCurrentDay();
                // If a new day started and the previous day was already read, clear it only if it's the specific old day
                // No, just increment the current day. If the new day has a reader, that's fine.
                // If we want to ensure new day is always empty, we would need to clear chapterStatuses[currentDay]
                // but that might erase a previous reading.
                // For simplicity, just increment. The current display logic will show if it's read.
                showMessage(`יום חדש החל! כעת ביום ${currentDay} במחזור.`);
            }

            currentDaySpan.textContent = currentDay;
            const chapterInfo = window.tehillimChapters[currentDay];
            currentChapterRangeSpan.textContent = chapterInfo ? chapterInfo.hebrew : 'לא נמצאו פרקים';

            const status = chapterStatuses[currentDay];
            if (status && status.reader) {
                currentChapterReaderSpan.innerHTML = `נקרא ע"י: <span class="fw-bold">${status.reader}</span>`;
                markAsReadBtn.disabled = true;
                markAsReadBtn.textContent = 'כבר נקרא היום';
            } else {
                currentChapterReaderSpan.innerHTML = 'טרם נקרא';
                markAsReadBtn.disabled = false;
                markAsReadBtn.textContent = 'סימנתי כקראתי';
            }
        }

        function markReadStatusForParticipant() {
            if (currentParticipantId) {
                const participant = participants.find(p => p.id === currentParticipantId);
                if (participant) {
                    const dayToMark = currentDay;
                    if (!chapterStatuses[dayToMark] || !chapterStatuses[dayToMark].reader) {
                        chapterStatuses[dayToMark] = {
                            reader: participant.name,
                            readerId: participant.id, // Save participant ID
                            timestamp: new Date().toISOString()
                        };
                        saveChapterStatuses();
                        showMessage(`סימנת את פרקי יום ${dayToMark} כנקראו. תודה!`, 'success');
                        assignTodaysChapterToParticipant(participant); // Update display immediately
                    } else {
                        showMessage(`פרקי יום ${dayToMark} כבר סומנו כנקראו ע"י ${chapterStatuses[dayToMark].reader}.`, 'info');
                    }
                }
            } else {
                showMessage("יש להתחבר כדי לסמן קריאה.", "error");
            }
        }

        function deleteParticipant(idToDelete) {
            showConfirm("האם אתה בטוח שברצונך למחוק משתתף זה? פעולה זו אינה הפיכה ותמחק את כל הקריאות שהוקצו לו.", (confirmed) => {
                if (confirmed) {
                    const participantToDelete = participants.find(p => p.id === idToDelete);
                    if (!participantToDelete) return;

                    // Remove participant from the list
                    participants = participants.filter(p => p.id !== idToDelete);
                    saveParticipants(); // Save to local storage

                    // Remove participant's name from chapter statuses
                    for (const day in chapterStatuses) {
                        if (chapterStatuses[day].readerId === idToDelete) { // Use readerId to ensure correct deletion
                            delete chapterStatuses[day].reader;
                            delete chapterStatuses[day].readerId;
                            delete chapterStatuses[day].timestamp;
                        }
                    }
                    saveChapterStatuses(); // Save updated statuses to local storage

                    // If the deleted participant was currently logged in, log them out
                    if (currentParticipantId === idToDelete) {
                        currentParticipantId = null;
                        localStorage.removeItem('currentParticipantId');
                        localStorage.removeItem('isAdminLoggedIn');
                    }

                    showMessage(`המשתתף "${participantToDelete.name}" נמחק בהצלחה.`);
                    updateAdminPanel();
                    updateDisplay();
                }
            });
        }

        function showParticipantHistory(participantId) {
            currentEditedParticipantId = participantId;
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;

            participantHistoryNameSpan.textContent = participant.name;
            participantHistoryList.innerHTML = ''; // Clear previous history

            const readChapters = Object.keys(chapterStatuses)
                .filter(day => chapterStatuses[day] && chapterStatuses[day].readerId === participantId)
                .sort((a, b) => parseInt(a) - parseInt(b));

            if (readChapters.length === 0) {
                participantHistoryList.innerHTML = '<p class="text-center text-muted">המשתתף לא קרא אף פרק עדיין.</p>';
            } else {
                readChapters.forEach(day => {
                    const status = chapterStatuses[day];
                    const chapter = window.tehillimChapters[day];
                    const timestamp = status.timestamp ? new Date(status.timestamp).toLocaleString('he-IL') : 'לא ידוע';

                    const item = document.createElement('div');
                    item.className = 'chapter-box read my-2';
                    item.innerHTML = `
                        <span>יום ${day}: פרקים ${chapter.chapters}</span><br>
                        <small>קריאה: ${timestamp}</small>
                    `;
                    participantHistoryList.appendChild(item);
                });
            }

            selectedParticipantHistoryPanel.style.display = 'block';
            overlay.style.display = 'block';
        }


        function showProgressView() {
            mainContainer.style.display = 'none';
            progressView.style.display = 'block';
            renderProgressGrid();
        }

        function hideProgressView() {
            progressView.style.display = 'none';
            mainContainer.style.display = 'block';
            updateDisplay();
        }

        function renderProgressGrid() {
            progressGrid.innerHTML = '';
            for (let i = 1; i <= 30; i++) {
                const chapter = window.tehillimChapters[i];
                const status = chapterStatuses[i];
                const isRead = status && status.reader;
                const readerName = status && status.reader ? status.reader : '';

                const chapterBox = document.createElement('div');
                chapterBox.className = `progress-chapter-box ${isRead ? 'read' : ''}`;
                chapterBox.innerHTML = `
                    <div class="chapter-number">${i}</div>
                    <span>${chapter.hebrew}</span>
                    ${isRead ? `<div class="reader-name">${readerName}</div>` : ''}
                `;
                progressGrid.appendChild(chapterBox);
            }
        }


        function addParticipantManually() {
            const name = newParticipantNameInput.value.trim();
            const phone = newParticipantPhoneInput.value.trim();

            if (!name) {
                showMessage("יש להזין שם משתתף.", "error");
                return;
            }

            if (phone && !isValidPhoneNumber(phone)) {
                showMessage("מספר הטלפון אינו תקין. אנא הזן 7-15 ספרות (אופציונלית עם + בתחילה).", "error");
                return;
            }

            const formattedPhone = phone ? formatPhoneNumber(phone) : '';

            // Check for duplicate name (case-insensitive)
            if (participants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showMessage(`משתתף בשם "${name}" כבר קיים.`, "error");
                return;
            }

            const newParticipant = {
                id: crypto.randomUUID(), // Generate a unique ID
                name: name,
                phone: formattedPhone
            };

            participants.push(newParticipant);
            saveParticipants(); // Save to local storage
            showMessage(`המשתתף "${name}" נוסף בהצלחה!`, "success");
            newParticipantNameInput.value = '';
            newParticipantPhoneInput.value = '';
            addParticipantSection.style.display = 'none';
            updateAdminPanel();
        }

        function showManualAddSection() {
            addParticipantSection.style.display = 'block';
        }

        function cancelManualAdd() {
            newParticipantNameInput.value = '';
            newParticipantPhoneInput.value = '';
            addParticipantSection.style.display = 'none';
        }


        function resetAllData() {
            showConfirm("האם אתה בטוח שברצונך לאתחל את כל הנתונים (מחזור תהילים, משתתפים, קריאות)? פעולה זו אינה הפיכה.", (confirmed) => {
                if (confirmed) {
                    currentDay = 1;
                    chapterStatuses = {};
                    participants = [];
                    currentParticipantId = null;
                    localStorage.clear(); // Clear all local storage
                    showMessage("כל הנתונים אופסו בהצלחה.", "success");
                    updateDisplay();
                }
            });
        }


        function exportData() {
            const data = {
                currentDay: currentDay,
                chapterStatuses: chapterStatuses,
                participants: participants
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tehillim_data_export_${getTodayDateString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("הנתונים יוצאו בהצלחה כקובץ JSON.", "success");
        }


        // Event Listeners
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const ADMIN_PASSWORD = 'admin'; // Replace with a more secure method later

            clearMessages();

            if (username === 'admin' && password === ADMIN_PASSWORD) {
                localStorage.setItem(IS_ADMIN_LOGGED_IN_KEY, 'true');
                localStorage.removeItem('currentParticipantId'); // Clear participant login if admin logs in
                currentParticipantId = null;
                showMessage("התחברת כמנהל בהצלחה!", 'success');
            } else if (username) {
                let participant = participants.find(p => p.name === username);
                if (!participant) {
                    // Create new participant with a unique ID
                    participant = { id: crypto.randomUUID(), name: username, phone: '' };
                    participants.push(participant);
                    saveParticipants();
                    showMessage(`ברוך הבא, ${username}! חשבונך נוצר.`, 'success');
                }
                localStorage.setItem('currentParticipantId', participant.id);
                localStorage.removeItem('isAdminLoggedIn');
                currentParticipantId = participant.id;
                currentParticipantNameSpan.textContent = username;
                assignTodaysChapterToParticipant(participant);
            } else {
                showMessage('אנא הכנס שם משתמש.', 'error');
            }
            updateDisplay();
            usernameInput.value = '';
            passwordInput.value = '';
        });

        logoutBtn.addEventListener('click', () => {
            showConfirm("האם אתה בטוח שברצונך להתנתק?", (confirmed) => {
                if (confirmed) {
                    currentParticipantId = null;
                    localStorage.removeItem('currentParticipantId');
                    showMessage("התנתקת בהצלחה.", 'info');
                    updateDisplay();
                }
            });
        });

        logoutAdminBtn.addEventListener('click', () => {
            showConfirm("האם אתה בטוח שברצונך להתנתק ממצב מנהל?", (confirmed) => {
                if (confirmed) {
                    localStorage.removeItem(IS_ADMIN_LOGGED_IN_KEY);
                    showMessage("התנתקת ממצב מנהל.", 'info');
                    updateDisplay();
                }
            });
        });

        // Admin Tab Events
        const adminTabs = new bootstrap.Tab(document.getElementById('current-day-tab'));
        adminTabs.show(); // Show current day tab by default

        // Data Management button (from admin panel to data-manager.html)
        dataManagementBtn.addEventListener('click', () => {
            // In an Electron app, you might open a new window or use ipcMain to load a new HTML
            // For a simple web app or PWA, this would navigate:
            // window.location.href = 'data-manager.html';
            // In Electron main process, you'd handle this more elegantly.
            // For now, let's just log it.
            showMessage("פתח את 'data-manager.html' באופן ידני לניהול נתונים.", "info");
            // If you want to load it in the same window (less ideal for modal like behavior):
            // window.location.href = 'data-manager.html';
        });


        // New participant buttons
        addParticipantBtn.addEventListener('click', showManualAddSection);
        confirmAddParticipantBtn.addEventListener('click', addParticipantManually);
        cancelAddParticipantBtn.addEventListener('click', cancelManualAdd);

        // Edit reading history buttons
        if (saveEditHistoryBtn) {
            saveEditHistoryBtn.addEventListener('click', saveEditHistory);
        }
        if (clearReadingBtn) {
            clearReadingBtn.addEventListener('click', () => clearChapterReading(currentEditedChapterDay, true));
        }
        if (hideEditHistoryBtn) {
            hideEditHistoryBtn.addEventListener('click', hideEditReadingHistoryPanel);
        }

        // --- סוף חדש ---

        // ייצוא נתונים (רק לאדמין)
        const exportDataBtn = document.getElementById('exportDataBtn');
        if (exportDataBtn) exportDataBtn.addEventListener('click', exportData);

        // כפתור "סימנתי כקראתי" (רק למשתתף)
        // הערה: קוד זה הועבר לתוך assignTodaysChapterToParticipant() ו-markReadStatusForParticipant()
        // ומתייחס ל-markAsReadBtn שכבר מטופל.

        // כפתורי תצוגת התקדמות
        const viewProgressBtnElement = document.getElementById('viewProgressBtn');
        if (viewProgressBtnElement) viewProgressBtnElement.addEventListener('click', showProgressView);

        const backToReadingBtnElement = document.getElementById('backToReadingBtn');
        if (backToReadingBtnElement) backToReadingBtnElement.addEventListener('click', hideProgressView);

        const incrementDayBtnElement = document.getElementById('incrementDayBtn');
        if (incrementDayBtnElement) {
            incrementDayBtnElement.addEventListener('click', () => {
                showConfirm("האם אתה בטוח שברצונך להעביר ליום הבא במחזור? (המחזור יתחיל מחדש ביום 30)", (confirmed) => {
                    if (confirmed) {
                        currentDay = (currentDay % 30) + 1;
                        saveCurrentDay(); // Save to local storage
                        localStorage.removeItem(LAST_ASSIGNMENT_DATE_KEY); // Clear last assignment date to force new day check on next login
                        showMessage(`היום הועבר ליום ${currentDay} במחזור.`);
                        updateAdminPanel();
                    }
                });
            });
        }

        const resetCycleBtnElement = document.getElementById('resetCycleBtn');
        if (resetCycleBtnElement) {
            resetCycleBtnElement.addEventListener('click', () => {
                showConfirm("האם אתה בטוח שברצונך לאתחל את כל מחזור התהילים? כל סטטוסי הקריאה יימחקו.", (confirmed) => {
                    if (confirmed) {
                        currentDay = 1;
                        chapterStatuses = {};
                        saveCurrentDay(); // Save to local storage
                        saveChapterStatuses(); // Save to local storage
                        localStorage.removeItem(LAST_ASSIGNMENT_DATE_KEY); // Clear last assignment date
                        showMessage("מחזור התהילים אופס בהצלחה.");
                        updateAdminPanel();
                    }
                });
            });
        }

        const resetDataBtnElement = document.getElementById('resetDataBtn');
        // This button is likely in data-manager.html, not main.html
        // if (resetDataBtnElement) resetDataBtnElement.addEventListener('click', resetAllData);

        // Initial load and display on document ready
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateDisplay();
        });

    </script>
</body>
</html>
