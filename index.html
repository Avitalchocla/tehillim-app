<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🕯️ קריאת תהילים קבוצתית 🕯️</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .app-title {
            text-align: center;
            color: #1e40af;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .date-info {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            text-align: center;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        
        .btn-whatsapp {
            background-color: #25d366;
            color: white;
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .participant-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .participant-row:last-child {
            border-bottom: none;
        }
        
        .participant-info {
            flex: 1;
        }
        
        .participant-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .participant-chapters {
            color: #6b7280;
            font-size: 14px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .progress-section {
            text-align: center;
            padding: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            transition: width 0.3s ease;
        }
        
        .simple-view {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .chapter-display {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const tehillimDivision = {
            1: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט'],
            2: ['י', 'יא', 'יב', 'יג', 'יד', 'טו', 'טז', 'יז'],
            3: ['יח', 'יט', 'כ', 'כא', 'כב'],
            4: ['כג', 'כד', 'כה', 'כו', 'כז', 'כח'],
            5: ['כט', 'ל', 'לא', 'לב', 'לג', 'לד'],
            6: ['לה', 'לו', 'לז', 'לח'],
            7: ['לט', 'מ', 'מא', 'מב', 'מג'],
            8: ['מד', 'מה', 'מו', 'מז', 'מח'],
            9: ['מט', 'נ', 'נא', 'נב', 'נג', 'נד'],
            10: ['נה', 'נו', 'נז', 'נח', 'נט'],
            11: ['ס', 'סא', 'סב', 'סג', 'סד', 'סה'],
            12: ['סו', 'סז', 'סח'],
            13: ['סט', 'ע', 'עא'],
            14: ['עב', 'עג', 'עד', 'עה', 'עו'],
            15: ['עז', 'עח'],
            16: ['עט', 'פ', 'פא', 'פב'],
            17: ['פג', 'פד', 'פה', 'פו', 'פז'],
            18: ['פח', 'פט'],
            19: ['צ', 'צא', 'צב', 'צג', 'צד', 'צה'],
            20: ['צו', 'צז', 'צח', 'צט', 'ק'],
            21: ['קא', 'קב', 'קג', 'קד', 'קה'],
            22: ['קו', 'קז', 'קח', 'קט'],
            23: ['קי', 'קיא', 'קיב', 'קיג', 'קיד', 'קטו', 'קטז', 'קיז', 'קיח'],
            24: ['קיט'],
            25: ['קכ', 'קכא', 'קכב', 'קכג', 'קכד', 'קכה', 'קכו', 'קכז', 'קכח', 'קכט', 'קל', 'קלא', 'קלב', 'קלג', 'קלד'],
            26: ['קלה', 'קלו', 'קלז', 'קלח', 'קלט'],
            27: ['קמ', 'קמא', 'קמב', 'קמג', 'קמד', 'קמה'],
            28: ['קמו', 'קמז', 'קמח', 'קמט'],
            29: ['קנ'],
            30: ['תהילה לדוד']
        };

        const getTodayInfo = () => {
            const today = new Date();
            const dayOfMonth = today.getDate();
            
            const cycleOverride = localStorage.getItem('cycleOverride');
            let cycleDay;
            
            if (cycleOverride) {
                const override = JSON.parse(cycleOverride);
                const originalDate = new Date(override.originalDate);
                const currentDate = new Date();
                const daysDiff = Math.floor((currentDate - originalDate) / (1000 * 60 * 60 * 24));
                cycleDay = ((override.overrideCycleDay - 1 + daysDiff) % 30) + 1;
            } else {
                cycleDay = ((dayOfMonth - 1) % 30) + 1;
            }
            
            return {
                dayOfMonth,
                cycleDay,
                hebrewDate: today.toLocaleDateString('he-IL')
            };
        };

        const getParticipantAssignment = (participantId, todayInfo) => {
            const assignmentDay = participantId;
            const chapters = tehillimDivision[assignmentDay] || [];
            return { participantId, assignmentDay, chapters, todayInfo };
        };

        const loadParticipants = () => {
            const savedData = localStorage.getItem('tehillimParticipants');
            if (savedData) {
                try {
                    return JSON.parse(savedData);
                } catch (e) {
                    console.error('Error parsing saved data:', e);
                }
            }
            
            const defaultParticipants = [];
            for (let i = 1; i <= 30; i++) {
                defaultParticipants.push({
                    id: i,
                    name: `משתתף ${i}`,
                    phone: `+972-50-000-${i.toString().padStart(4, '0')}`
                });
            }
            return defaultParticipants;
        };

        const getAppUrl = () => {
            return window.location.origin + window.location.pathname;
        };

        const createWhatsAppLink = (participant, todayInfo) => {
            const assignment = getParticipantAssignment(participant.id, todayInfo);
            const chaptersText = assignment.chapters.join('-');
            const appUrl = getAppUrl();
            
            const message = `📖 שלום ${participant.name}! 

🗓️ היום ${todayInfo.hebrewDate}
📊 יום ${todayInfo.cycleDay} במחזור התהילים

📜 החלק שלך להיום: פרקים ${chaptersText}

🤝 אם כולם יקראו - נשלים יחד את כל התהילים היום! ✨

✅ לאישור שקראת: ${appUrl}?participant=${participant.id}
📱 לצפייה בהתקדמות: ${appUrl}

תודה שאתה חלק מהמעגל הקדוש! 🕯️`;

            const cleanPhone = participant.phone.replace('+972-', '972').replace(/-/g, '');
            return `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(message)}`;
        };

        const TehillimApp = () => {
            const [readingStatus, setReadingStatus] = useState({});
            const [todayInfo, setTodayInfo] = useState(getTodayInfo());
            const [participants, setParticipants] = useState([]);

            const urlParams = new URLSearchParams(window.location.search);
            const participantId = urlParams.get('participant');
            const isParticipantView = participantId !== null;
            const currentParticipantId = isParticipantView ? parseInt(participantId) : null;

            useEffect(() => {
                setParticipants(loadParticipants());
                
                const savedStatus = localStorage.getItem(`reading-status-${todayInfo.cycleDay}`);
                if (savedStatus) {
                    try {
                        setReadingStatus(JSON.parse(savedStatus));
                    } catch (e) {
                        console.error('Error loading reading status:', e);
                    }
                }
            }, []);

            const resetCycle = () => {
                const today = new Date();
                const override = {
                    originalDate: today.toISOString(),
                    overrideCycleDay: 1
                };
                localStorage.setItem('cycleOverride', JSON.stringify(override));
                setTodayInfo(getTodayInfo());
                setReadingStatus({});
                localStorage.removeItem(`reading-status-${todayInfo.cycleDay}`);
            };

            useEffect(() => {
                localStorage.setItem(`reading-status-${todayInfo.cycleDay}`, JSON.stringify(readingStatus));
            }, [readingStatus, todayInfo.cycleDay]);

            const toggleReadingStatus = (participantId) => {
                setReadingStatus(prev => ({
                    ...prev,
                    [participantId]: !prev[participantId]
                }));
            };

            const completedCount = Object.values(readingStatus).filter(Boolean).length;
            const totalChapters = Object.values(tehillimDivision).flat().length;
            let completedChapters = 0;
            
            for (const [participantId, isRead] of Object.entries(readingStatus)) {
                if (isRead) {
                    const chapters = tehillimDivision[parseInt(participantId)] || [];
                    completedChapters += chapters.length;
                }
            }

            // תצוגת משתתף (מצומצמת)
            if (isParticipantView) {
                const assignment = getParticipantAssignment(currentParticipantId, todayInfo);
                const isCompleted = readingStatus[currentParticipantId] || false;
                const participant = participants.find(p => p.id === currentParticipantId);

                return (
                    <div className="container">
                        <h1 className="app-title">🕯️ קריאת תהילים קבוצתית 🕯️</h1>
                        
                        <div className="date-info">
                            <h3>📅 {todayInfo.hebrewDate}</h3>
                            <p>יום {todayInfo.cycleDay} במחזור התהילים</p>
                        </div>

                        <div className="card">
                            <h2>👤 משתתף {currentParticipantId}</h2>
                            
                            <div className="chapter-display">
                                <h3>📜 החלק שלך להיום:</h3>
                                <h2 style={{ color: '#3b82f6', margin: '16px 0' }}>
                                    פרקים {assignment.chapters.join('-')}
                                </h2>
                            </div>

                            <div style={{ textAlign: 'center', margin: '32px 0' }}>
                                <button
                                    className={`btn ${isCompleted ? 'btn-success' : 'btn-primary'}`}
                                    onClick={() => toggleReadingStatus(currentParticipantId)}
                                    style={{ padding: '16px 32px', fontSize: '18px' }}
                                >
                                    {isCompleted ? '✅ קראתי!' : '📖 לחץ אחרי שקראת'}
                                </button>
                            </div>

                            {isCompleted && (
                                <div style={{ 
                                    background: '#d1fae5', 
                                    color: '#065f46', 
                                    padding: '16px', 
                                    borderRadius: '12px',
                                    textAlign: 'center',
                                    marginTop: '16px'
                                }}>
                                    🎉 כל הכבוד! קראת את החלק שלך היום!
                                </div>
                            )}
                        </div>

                        <div className="card">
                            <div className="simple-view">
                                <h3>📊 התקדמות כללית</h3>
                                
                                <div style={{ marginBottom: '20px' }}>
                                    <h4>משתתפים שסיימו: {completedCount}/30</h4>
                                    <div className="progress-bar">
                                        <div 
                                            className="progress-fill" 
                                            style={{ width: `${(completedCount / 30) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>

                                <div>
                                    <h4>התקדמות בספר: {completedChapters}/{totalChapters} פרקים</h4>
                                    <div className="progress-bar">
                                        <div 
                                            className="progress-fill" 
                                            style={{ width: `${(completedChapters / totalChapters) * 100}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // תצוגת מנהל (עיצוב ישן)
            return (
                <div className="container">
                    <h1 className="app-title">🕯️ קריאת תהילים קבוצתית - ניהול 🕯️</h1>
                    
                    <div className="date-info">
                        <h3>📅 {todayInfo.hebrewDate}</h3>
                        <p>יום {todayInfo.cycleDay} במחזור התהילים</p>
                    </div>

                    <div className="card">
                        <h3>🎛️ פעולות ניהול</h3>
                        <div className="controls">
                            <button 
                                className="btn btn-warning"
                                onClick={resetCycle}
                            >
                                🔄 איפוס מחזור ליום 1
                            </button>
                        </div>
                    </div>

                    <div className="card">
                        <div className="progress-section">
                            <h3>📊 התקדמות היום</h3>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <h4>משתתפים שסיימו: {completedCount}/30</h4>
                                <div className="progress-bar">
                                    <div 
                                        className="progress-fill" 
                                        style={{ width: `${(completedCount / 30) * 100}%` }}
                                    ></div>
                                </div>
                            </div>

                            <div>
                                <h4>פרקים שנקראו: {completedChapters}/{totalChapters}</h4>
                                <div className="progress-bar">
                                    <div 
                                        className="progress-fill" 
                                        style={{ width: `${(completedChapters / totalChapters) * 100}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <h3>👥 רשימת משתתפים</h3>
                        {participants.map((participant) => {
                            const assignment = getParticipantAssignment(participant.id, todayInfo);
                            const isCompleted = readingStatus[participant.id] || false;
                            
                            return (
                                <div key={participant.id} className="participant-row">
                                    <div className="participant-info">
                                        <div className="participant-name">{participant.name}</div>
                                        <div className="participant-chapters">
                                            פרקים: {assignment.chapters.join('-')}
                                        </div>
                                    </div>
                                    
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                        <span className={`status-badge ${isCompleted ? 'status-completed' : 'status-pending'}`}>
                                            {isCompleted ? '✅ קרא' : '⏳ ממתין'}
                                        </span>
                                        
                                        <button
                                            className={`btn ${isCompleted ? 'btn-success' : 'btn-primary'}`}
                                            onClick={() => toggleReadingStatus(participant.id)}
                                            style={{ fontSize: '12px' }}
                                        >
                                            {isCompleted ? '↩️ בטל' : '✅ סמן כקרא'}
                                        </button>
                                        
                                        <a
                                            href={createWhatsAppLink(participant, todayInfo)}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="btn btn-whatsapp"
                                        >
                                            📱 WhatsApp
                                        </a>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TehillimApp />, document.getElementById('root'));
    </script>
</body>
</html>
